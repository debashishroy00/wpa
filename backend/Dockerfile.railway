# RAILWAY DEPLOYMENT - HARDCODED MINIMAL PACKAGES
# Same as Dockerfile.render but optimized for Railway

FROM python:3.11-slim

WORKDIR /app

# Railway-specific environment variables
ENV PYTHONOPTIMIZE=2 \
    PYTHONUNBUFFERED=1 \
    MALLOC_ARENA_MAX=2 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    CUDA_VISIBLE_DEVICES="" \
    USE_CUDA=0 \
    DISABLE_VECTOR_DB=true

# Install minimal system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Hardcoded package installation - NO requirements files
RUN pip install --no-cache-dir --no-compile \
    fastapi==0.104.1 \
    uvicorn==0.24.0 \
    sqlalchemy==2.0.23 \
    pydantic==2.5.0 \
    python-jose[cryptography]==3.3.0 \
    passlib[bcrypt]==1.7.4 \
    openai==1.3.0 \
    redis==5.0.1 \
    httpx==0.25.2 \
    psycopg2-binary==2.9.9 \
    python-multipart==0.0.6 \
    python-dotenv==1.0.0

# Copy only app directory
COPY app app/

# Inline startup script for Railway
RUN echo '#!/bin/bash\n\
exec uvicorn app.main:app \
    --host 0.0.0.0 \
    --port ${PORT:-8000} \
    --workers 1 \
    --limit-max-requests 500 \
    --limit-concurrency 10' > /app/start.sh && \
    chmod +x /app/start.sh

# Remove any requirements files
RUN rm -f /app/requirements*.txt

EXPOSE 8000

CMD ["/app/start.sh"]